---
tags:
  - 机器学习
  - 数据分析
author: WangXinYi
img: /images/homePage/机器学习.webp
top: false
summary: 机器学习比赛及常用函数
categories:
  - 机器学习
  - 数据分析
typora-root-url: ..
date: 2022-10-24 12:06:57
---


# 机器学习比赛

## 机器学习建模流程及常用函数

### 一、数据探索

+ 观察字段的缺失值
+ 观察Label分布
+ 观察唯一值的个数
+ 观察字段的相关性

#### 1、以直方图的形式展示数据信息

```python
import matplotlib.pyplot as plt
import seaborn as sns
# 以直方图的形式展示，isDefault表示显示数量
sns.countplot(x = 'grade',hue='isDefault',data=train)
```

#### 2、进行字段之间的相关性相关性分析

```python
# 对特征列进行相关性分析
import matplotlib.pyplot as plt
%matplotlib inline
import seaborn as sns
plt.figure(figsize=(10,10))
sns.heatmap(train.corr(),cbar=True,annot=True,cmap='Blues')
```

### 二、数据预处理

+ 数值类型和类别类型缺失值处理
+ 处理唯一值的个数为1字段
+ 数据规范化(深度学习才需要)

#### 1、删除全部唯一值为1字段

```python
features = train.columns.tolist()
for feature in features:
    if train[feature].nunique() ==1:
        train.drop([feature],axis=1,inplace=True)
        test.drop([feature],axis=1,inplace=True)
print('删除全部唯一值为1字段完成')
```

#### 2、将数值类型的缺失值全部以中位数补全

```python
#将数值类型的缺失值全部以中位数补全
numerical_fea = list(train.select_dtypes(include=['float']).columns)
train[numerical_fea] = train[numerical_fea].fillna(train[numerical_fea].median())
test[numerical_fea] = test[numerical_fea].fillna(test[numerical_fea].median())
print('数值类型缺失值,中位数填充完成')
```

#### 3、将类别类型的缺失值全部以众数补全

```python
#将类别类型的缺失值全部以众数补全
from scipy import stats 
cat_fea = list(train.select_dtypes(exclude=['float']).columns)
for cf in cat_fea:
    if train[cf].isnull().sum():
        train[cf] = train[cf].fillna(stats.mode(train[cf])[0][0])
cat_fea = list(test.select_dtypes(exclude=['float']).columns)
for cf in cat_fea:
    if test[cf].isnull().sum():
        test[cf] = test[cf].fillna(stats.mode(test[cf])[0][0])
print('类别类型缺失值,众数填充完成')
```

### 三、特征工程

特征编码（原来是个类别类型，比如说是个字符串，还需要把它变成数值类型），构造新特征，特征变换，

#### 1、特征编码，将object转换为数值类型

```python
from sklearn.preprocessing import LabelEncoder
le = LabelEncoder()
train['grade'] = le.fit_transform(train['grade'])
testA['grade'] = le.fit_transform(testA['grade'])
```

或者利用map自定义特征，

```python
#数据清洗特征添加
for data in [train]:
    data['grade'] = data['grade'].map({'A':1,'B':2,'C':3,'D':4,'E':5,'F':6,'G':7})
    
    data['employmentLength'] = data['employmentLength'].map(
    {'1 year':1,'2 years':2,'3 years':3,'4 years':4,'5 years':5,'6 years':6,
    '7 years':7,'8 years':8,'9 years':9,'10+ years':10,'< 1 year':0})
    
    data['subGrade'] = data['subGrade'].map(
    {'E2':1,'D2':2,'D3':3,'A4':4,'C2':5,'A5':6,'C3':7,'B4':8,'B5':9,'E5':10,
    'D4':11,'B3':12,'B2':13,'D1':14,'E1':15,'C5':16,'C1':17,'A2':18,'A3':19,'B1':20,
    'E3':21,'F1':22,'C4':23,'A1':24,'D5':25,'F2':26,'E4':27,'F3':28,'G2':29,'F5':30,
    'G3':31,'G1':32,'F4':33,'G4':34,'G5':35})
```

#### 2、时间多尺度变换与时间差计算

```python
import datetime
def create_days_diff(selected_cols):
    for selected in selected_cols:
        train[selected] = pd.to_datetime(train[selected])
        tmp_str = str(train[selected].min().year)+'-'+str("%02d" % train[selected].min().month)+'-'+str("%02d" % train[selected].min().day)
        startdate = datetime.datetime.strptime(tmp_str, '%Y-%m-%d')
        train[selected+'_diff'] = train[selected].apply(lambda x: x-startdate).dt.days
        
        test[selected] = pd.to_datetime(test[selected])
        tmp_str = str(test[selected].min().year)+'-'+str("%02d" % test[selected].min().month)+'-'+str("%02d" % test[selected].min().day)
        startdate = datetime.datetime.strptime(tmp_str, '%Y-%m-%d')
        test[selected+'_diff'] = test[selected].apply(lambda x: x-startdate).dt.days        
        print(selected+'_diff'+' 时间差字段 已经创建')
def create_ymd_features(selected_cols):
    for selected in selected_cols:
        test[selected] = pd.to_datetime(test[selected])
        train_temp = pd.DatetimeIndex(train[selected])
        test_temp = pd.DatetimeIndex(test[selected])
        
        train[selected+'_year'] = train_temp.year
        test[selected+'_year'] = test_temp.year
        print(selected+'_year'+'字段 已经创建')
        
        train[selected+'_month'] = train_temp.month
        test[selected+'_month'] = test_temp.month
        print(selected+'_month'+'字段 已经创建')
        
        train[selected+'_day'] = train_temp.day
        test[selected+'_day'] = test_temp.day
        print(selected+'_day'+'字段 已经创建')

#只需要在selected_cols列表中加入需要转换的字段
selected_cols = ['issueDate']
create_ymd_features(selected_cols)
create_days_diff(selected_cols)
```

#### 3、类别特征

**min，max，mean，std没有意义，因为是单一特征**

**只增加count，isDefault_mean（唯一值个数少的情况，如果唯一值多，会造成成标签泄露问题）**

```python
#cat_fea 为类别特征（一般是出float以外，时间类型也不算）
cat_fea =['term','grade','subGrade','employmentLength','homeOwnership','verificationStatus','purpose','regionCode','initialListStatus','applicationType']
#先看一下类别特征唯一值的个数
for feature in cat_fea:
    print(feature,train[feature].nunique())
df = pd.concat([train,test],axis = 0)
for col in cat_fea:
    temp = train.groupby(col,as_index=False)[col].agg({col+'_count': 'count'})
    df = pd.merge(df,temp,on = col,how = 'left')
    #isDefault为标签项，需要替换
    temp = train.groupby(col,as_index=False)['isDefault'].agg({col+'_isDefault_mean': 'mean'})
    df = pd.merge(df,temp,on = col,how = 'left')
train = df[df['isDefault'].notnull()]
test = df[df['isDefault'].isnull()]
```

#### 4、批量删除字段为object的字段

```python
# features = list(train.select_dtypes(include=['object']).columns)
features = ['lan', 'os', 'osv', 'version', 'label', 'sid','timestamp'] #自定义删除字段
for feature in features:
        train.drop([feature],axis=1,inplace=True)
print('批量删除字段已完成')
```

### 四、模型建立

机器学习神器：XGBoost，LightGBM，Catboost

图像/文本分类：各种NN

通常LightGBM更快（在CPU机上，优先使用）

### 五、参数调优

1、可视化的方式查看特征的重要程度

lightgbm

```python
import lightgbm as lgb
import matplotlib.pyplot as plt
fig,ax = plt.subplots(figsize=(20,16))
lgb.plot_importance(model_lgb,ax =ax,max_num_features = 10)#模型训练结果为model_lgb
plt.tirle('Important Features')
```

xgboost 

```python
from xgboost import plot_importance
import matplotlib.pyplot as plt
fig,ax = plt.subplots(figsize=(20,16))
plot_importance(model_xgb,ax =ax,max_num_features = 10)#模型训练结果为model_xgb
```

贝叶斯优化(主要是调树的深度)

### 六、模型融合

五折交叉验证融合

不同模型之间的融合

